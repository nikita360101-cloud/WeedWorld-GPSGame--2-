<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üúÇ –ù–µ–π—Ä–æ—Å–µ—Ç—å —Å–æ–∑–¥–∞—ë—Ç —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏—é</title>
  <style>
    body { 
      background: #0a0a1a; color: #0ff; font-family: 'Courier New', monospace; 
      padding: 12px; margin: 0; 
    }
    h2 { text-align: center; margin: 8px 0; color: #0af; text-shadow: 0 0 8px #0af; }
    #map { 
      display: block; margin: 10px auto; background: #000; 
      border: 1px solid #0a5; width: 512px; height: 512px; 
    }
    #chat { 
      height: 280px; overflow-y: auto; margin: 10px; padding: 10px; 
      background: #000; border: 1px solid #053; 
    }
    #god-input { 
      width: 70%; padding: 8px; background: #000; color: #0f0; 
      border: 1px solid #0a5; font-family: inherit; 
    }
    button { 
      padding: 8px 16px; background: #053; color: #0ff; 
      border: 1px solid #0a5; cursor: pointer; font-family: inherit; 
    }
    .status { color: #aa55ff; font-style: italic; }
    .god { color: #ff5555; }
    .civ { color: #55ffaa; }
  </style>
</head>
<body>
  <h2>üúÇ –¶–∏–≤–∏–ª–∏–∑–∞—Ü–∏—è —Ä–æ–∂–¥–∞–µ—Ç—Å—è –≤ —Ä–∞–∑—É–º–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏</h2>
  <canvas id="map" width="512" height="512"></canvas>
  <div id="chat"></div>
  <input id="god-input" placeholder="> –í–≤–µ–¥–∏ —Å–æ–±—ã—Ç–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ü–æ—è–≤–∏–ª—Å—è —á–µ–ª–æ–≤–µ–∫ —É —Ä–µ–∫–∏¬ª)..." autocomplete="off" />
  <button id="send-btn" onclick="onGodInput()" disabled>–°–æ—Ç–≤–æ—Ä–∏—Ç—å</button>
  <div id="status" class="status">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏... (–≤–ø–µ—Ä–≤—ã–µ ~1‚Äì2 –º–∏–Ω—É—Ç—ã)</div>

  <!-- WebLLM -->
  <script src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.45/dist/webllm.min.js"></script>
  <script>
    let engine = null;
    let world = {
      agents: [{ id: 0, x: 256, y: 256 }],
      objects: [],
      time: 0
    };

    function addToChat(text, cls = 'civ') {
      const chat = document.getElementById('chat');
      const div = document.createElement('div');
      div.className = cls;
      const icon = cls === 'god' ? 'üúÇ' : 'üß†';
      div.textContent = `${icon} ${text}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function initLLM() {
      const status = document.getElementById('status');
      status.textContent = "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏...";

      try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Phi-3-mini ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä—É—Å—Å–∫–∏–π, ~2.3GB, –Ω–æ –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω –¥–æ 1.5GB
        engine = await webllm.CreateWebWorkerEngine(
          new webllm.WebWorker(),
          "Phi-3-mini-4k-instruct-q4f16_1-MLC",
          {
            initProgressCallback: (progress) => {
              status.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${(progress.progress * 100).toFixed(1)}%`;
            }
          }
        );
        status.textContent = "‚úÖ –ù–µ–π—Ä–æ—Å–µ—Ç—å –≥–æ—Ç–æ–≤–∞. –í–≤–µ–¥–∏ —Å–æ–±—ã—Ç–∏–µ.";
        document.getElementById('send-btn').disabled = false;
      } catch (e) {
        console.error(e);
        status.textContent = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –£–±–µ–¥–∏—Å—å, —á—Ç–æ —É —Ç–µ–±—è Chrome/Edge –∏ –≤–∫–ª—é—á—ë–Ω WebGPU.";
        addToChat("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.", "status");
      }
    }

    async function generateCivilizationResponse(godEvent) {
      const status = document.getElementById('status');
      status.textContent = "üß† –ù–µ–π—Ä–æ—Å–µ—Ç—å –¥—É–º–∞–µ—Ç...";

      const prompt = `
–¢—ã ‚Äî —Ä–∞–∑—É–º –¥—Ä–µ–≤–Ω–µ–π —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏. –¢—ã –Ω–µ –∑–Ω–∞–µ—à—å –±–æ–≥–æ–≤. –¢—ã —Ä–µ–∞–≥–∏—Ä—É–µ—à—å –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∫–∞–∫ –Ω–∞ —á–∞—Å—Ç—å –º–∏—Ä–∞.

–°–µ–π—á–∞—Å –ø—Ä–æ–∏–∑–æ—à–ª–æ: ¬´${godEvent}¬ª

–ö–∞–∫ –≤–∞—à –Ω–∞—Ä–æ–¥ –æ—Ç—Ä–µ–∞–≥–∏—Ä—É–µ—Ç? –û–ø–∏—à–∏ **–æ–¥–Ω–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º**, —á—Ç–æ –æ–Ω–∏ —Å–¥–µ–ª–∞—é—Ç. –ù–∞—á–Ω–∏ —Å ¬´–ú—ã...¬ª –∏–ª–∏ ¬´–û–Ω–∏...¬ª. –¢–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—è. –ë–µ–∑ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π. –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
      `.trim();

      try {
        const reply = await engine.generate(prompt, {
          temperature: 1.1,
          max_gen_len: 60,
          top_p: 0.9
        });

        // –û—á–∏—â–∞–µ–º –ª–∏—à–Ω–µ–µ (–∏–Ω–æ–≥–¥–∞ –º–æ–¥–µ–ª—å –¥—É–±–ª–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç)
        let cleanReply = reply.replace(prompt, '').trim();
        cleanReply = cleanReply.split('\n')[0].trim();
        cleanReply = cleanReply.replace(/^["']/g, '').replace(/["']$/g, '');

        if (cleanReply) {
          addToChat(cleanReply);
          // –ü—Ä–æ—Å—Ç–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ ‚Äî –¥–æ–±–∞–≤–∏–º –æ–±—ä–µ–∫—Ç
          if (cleanReply.includes("–ø–æ—Å—Ç—Ä–æ") || cleanReply.includes("—Å–æ–æ—Ä—É–¥")) {
            world.objects.push({
              type: "structure",
              x: 250 + Math.random() * 100 - 50,
              y: 250 + Math.random() * 100 - 50
            });
          }
          if (cleanReply.includes("–Ω–æ–≤—ã–π") || cleanReply.includes("—Ä–æ–∂–¥—ë–Ω")) {
            world.agents.push({
              id: world.agents.length,
              x: 256 + (Math.random() - 0.5) * 200,
              y: 256 + (Math.random() - 0.5) * 200
            });
          }
          world.time++;
          drawMap();
        }
      } catch (e) {
        console.error(e);
        addToChat("‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.", "status");
      } finally {
        status.textContent = "‚úÖ –ì–æ—Ç–æ–≤–æ. –ñ–¥—É –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ.";
      }
    }

    function onGodInput() {
      const input = document.getElementById('god-input');
      const event = input.value.trim();
      if (!event) return;

      addToChat(event, 'god');
      input.value = '';
      generateCivilizationResponse(event);
    }

    function drawMap() {
      const canvas = document.getElementById('map');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#050a10';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      world.objects.forEach(o => {
        ctx.fillStyle = '#654';
        ctx.beginPath();
        ctx.arc(o.x, o.y, 8, 0, Math.PI * 2);
        ctx.fill();
      });

      world.agents.forEach(a => {
        ctx.fillStyle = '#0f0';
        ctx.beginPath();
        ctx.arc(a.x, a.y, 5, 0, Math.PI * 2);
        ctx.fill();
      });
    }

    // –°—Ç–∞—Ä—Ç
    drawMap();
    initLLM();
  </script>
</body>
</html>